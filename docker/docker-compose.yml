# ============================================================================
# Magentic-UI DGX Spark Stack - Docker Compose Configuration
# ============================================================================
# vLLM inference server with Fara-7B
# Target: NVIDIA DGX Spark (Blackwell GB10, 128GB Unified Memory)
# ============================================================================
#
# Note: Magentic-UI runs natively on the host via `magentic-ui` command.
#       This compose file only manages the vLLM inference server.
#
# Usage:
#   docker compose up -d        # Start vLLM
#   docker compose logs -f      # View logs
#   docker compose down         # Stop vLLM
#
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # vLLM Inference Server with Fara-7B
  # ==========================================================================
  vllm-fara:
    image: ${VLLM_IMAGE:-nvcr.io/nvidia/vllm:25.09-py3}
    container_name: vllm-fara
    runtime: nvidia
    ports:
      - "${VLLM_PORT:-5000}:${VLLM_PORT:-5000}"
    volumes:
      - ../models:/models:rw
      - ../logs:/logs:rw
      - huggingface_cache:/root/.cache/huggingface
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - HF_TOKEN=${HUGGINGFACE_TOKEN:-}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - VLLM_LOGGING_LEVEL=${LOG_LEVEL:-INFO}
    command: >
      vllm serve ${VLLM_MODEL:-microsoft/Fara-7B}
        --host 0.0.0.0
        --port ${VLLM_PORT:-5000}
        --dtype ${VLLM_DTYPE:-auto}
        --max-model-len ${VLLM_MAX_MODEL_LEN:-16384}
        --gpu-memory-utilization ${VLLM_GPU_MEMORY_UTILIZATION:-0.85}
        --trust-remote-code
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${VLLM_PORT:-5000}/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s  # 5 min for model loading
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - magentic-network

# ============================================================================
# Networks
# ============================================================================
networks:
  magentic-network:
    name: magentic-network
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
volumes:
  huggingface_cache:
    name: magentic-hf-cache
